local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local workspace = game:GetService("Workspace")

-- C·∫•u h√¨nh
local COLLECT_DISTANCE = 50  -- Kho·∫£ng c√°ch t√¨m ki·∫øm Bond
local TELEPORT_ENABLED = true  -- B·∫≠t/t·∫Øt teleport
local AUTO_COLLECT_ENABLED = true  -- B·∫≠t/t·∫Øt auto collect
local COLLECT_DELAY = 0.1  -- Delay gi·ªØa m·ªói l·∫ßn check

-- T√™n ch√≠nh x√°c c·ªßa Bond trong game
local BOND_NAMES = {
    "Treasury Bond",
    "TreasuryBond",
    "Treasury_Bond"
}

-- Tracking
local totalBondsCollected = 0
local lastBondCount = 0

-- H√†m ki·ªÉm tra Bond hi·ªán t·∫°i trong leaderstats
local function getCurrentBonds()
    local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
    if leaderstats then
        -- T√¨m stat Bond ch√≠nh x√°c
        local bondStat = leaderstats:FindFirstChild("Bond") or 
                         leaderstats:FindFirstChild("Bonds") or
                         leaderstats:FindFirstChild("Treasury") or
                         leaderstats:FindFirstChild("Money")
        if bondStat and bondStat.Value then
            return bondStat.Value
        end
    end
    
    return 0
end

-- H√†m t√¨m t·∫•t c·∫£ Treasury Bond trong workspace
local function findAllBonds()
    local bonds = {}
    
    local function searchInFolder(folder)
        for _, obj in pairs(folder:GetChildren()) do
            -- T√¨m Treasury Bond ch√≠nh x√°c
            for _, bondName in pairs(BOND_NAMES) do
                if obj.Name == bondName or string.find(obj.Name, bondName) then
                    -- Treasury Bond th∆∞·ªùng l√† Part ho·∫∑c Model c√≥ th·ªÉ click
                    if obj:IsA("Part") or (obj:IsA("Model") and obj.PrimaryPart) then
                        local position = nil
                        if obj:IsA("Part") then
                            position = obj.Position
                        elseif obj:IsA("Model") and obj.PrimaryPart then
                            position = obj.PrimaryPart.Position
                        end
                        
                        if position then
                            table.insert(bonds, {
                                object = obj,
                                position = position,
                                name = obj.Name
                            })
                        end
                    end
                    break
                end
            end
            
            -- T√¨m trong c√°c folder con
            if obj:IsA("Folder") or obj:IsA("Model") then
                searchInFolder(obj)
            end
        end
    end
    
    searchInFolder(workspace)
    return bonds
end

-- H√†m t√≠nh kho·∫£ng c√°ch
local function getDistance(pos1, pos2)
    return (pos1 - pos2).Magnitude
end

-- H√†m teleport ƒë·∫øn Bond
local function teleportToBond(bondData)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local hrp = character.HumanoidRootPart
    local targetPos = bondData.position + Vector3.new(0, 5, 0) -- Teleport h∆°i cao m·ªôt ch√∫t
    
    hrp.CFrame = CFrame.new(targetPos)
    print("üöÄ Teleported to Bond:", bondData.name, "at", bondData.position)
    return true
end

-- H√†m di chuy·ªÉn ƒë·∫øn Bond (alternative cho teleport)
local function walkToBond(bondData)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("Humanoid") then
        return false
    end
    
    local humanoid = character.Humanoid
    humanoid:MoveTo(bondData.position)
    return true
end

-- H√†m collect Treasury Bond b·∫±ng c√°ch click
local function collectBond(bondData)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local hrp = character.HumanoidRootPart
    local distance = getDistance(hrp.Position, bondData.position)
    
    -- Teleport g·∫ßn Bond ƒë·ªÉ click
    if distance > COLLECT_DISTANCE then
        if TELEPORT_ENABLED then
            teleportToBond(bondData)
            task.wait(0.1)
        else
            walkToBond(bondData)
            return false
        end
    end
    
    -- Click v√†o Treasury Bond ƒë·ªÉ collect
    pcall(function()
        local targetObject = bondData.object
        
        -- Method 1: T√¨m ClickDetector
        local clickDetector = targetObject:FindFirstChildOfClass("ClickDetector")
        if clickDetector then
            fireclickdetector(clickDetector)
            print("üéØ Clicked Treasury Bond with ClickDetector")
            return true
        end
        
        -- Method 2: N·∫øu l√† Part, simulate mouse click
        if targetObject:IsA("Part") then
            -- D√πng mouse.Target ƒë·ªÉ click
            local mouse = LocalPlayer:GetMouse()
            mouse.Target = targetObject
            
            -- Ho·∫∑c d√πng VirtualInputManager ƒë·ªÉ click tr·ª±c ti·∫øp
            local cam = workspace.CurrentCamera
            local screenPoint = cam:WorldToScreenPoint(bondData.position)
            
            local VIM = game:GetService("VirtualInputManager")
            VIM:SendMouseButtonEvent(screenPoint.X, screenPoint.Y, 0, true, nil, 0)
            task.wait(0.05)
            VIM:SendMouseButtonEvent(screenPoint.X, screenPoint.Y, 0, false, nil, 0)
            print("üéØ Clicked Treasury Bond with VIM")
        end
        
        -- Method 3: N·∫øu l√† Model, t√¨m Part ch√≠nh ƒë·ªÉ click
        if targetObject:IsA("Model") then
            local mainPart = targetObject.PrimaryPart or targetObject:FindFirstChildOfClass("Part")
            if mainPart then
                local clickDetector = mainPart:FindFirstChildOfClass("ClickDetector")
                if clickDetector then
                    fireclickdetector(clickDetector)
                    print("üéØ Clicked Treasury Bond Model")
                end
            end
        end
    end)
    
    return true
end

-- H√†m ki·ªÉm tra Bond ƒë√£ ƒë∆∞·ª£c collect ch∆∞a
local function isBondStillThere(bondData)
    return bondData.object and bondData.object.Parent
end

-- Main Auto-Collect Loop
local function startAutoBondCollector()
    print("ü§ñ Auto Bond Collector Started!")
    print("üìç Teleport:", TELEPORT_ENABLED and "ON" or "OFF")
    print("üîÑ Auto Collect:", AUTO_COLLECT_ENABLED and "ON" or "OFF")
    print("üìè Collect Distance:", COLLECT_DISTANCE)
    
    while AUTO_COLLECT_ENABLED do
        pcall(function()
            -- Update Bond count
            local currentBonds = getCurrentBonds()
            if currentBonds ~= lastBondCount then
                local gained = currentBonds - lastBondCount
                if gained > 0 then
                    totalBondsCollected = totalBondsCollected + gained
                    print("üí∞ Bonds gained:", gained, "| Total:", currentBonds, "| Session:", totalBondsCollected)
                end
                lastBondCount = currentBonds
            end
            
            -- T√¨m v√† collect Bond
            local bonds = findAllBonds()
            if #bonds > 0 then
                print("üîç Found", #bonds, "Bond(s) in area")
                
                -- S·∫Øp x·∫øp theo kho·∫£ng c√°ch g·∫ßn nh·∫•t
                local character = LocalPlayer.Character
                if character and character:FindFirstChild("HumanoidRootPart") then
                    local myPos = character.HumanoidRootPart.Position
                    
                    table.sort(bonds, function(a, b)
                        return getDistance(myPos, a.position) < getDistance(myPos, b.position)
                    end)
                    
                    -- Collect Bond g·∫ßn nh·∫•t
                    for i, bondData in ipairs(bonds) do
                        if isBondStillThere(bondData) then
                            local distance = getDistance(myPos, bondData.position)
                            print("üéØ Targeting Bond:", bondData.name, "Distance:", math.floor(distance))
                            
                            if collectBond(bondData) then
                                print("‚úÖ Collected Bond:", bondData.name)
                                task.wait(0.2) -- Ch·ªù collect ho√†n th√†nh
                                break -- Ch·ªâ collect 1 bond m·ªói l·∫ßn
                            end
                        end
                    end
                end
            end
        end)
        
        task.wait(COLLECT_DELAY)
    end
end

-- ESP cho Bond (hi·ªÉn th·ªã v·ªã tr√≠)
local bondESP = {}

local function createBondESP(bondData)
    local character = LocalPlayer.Character
    if not character then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0, 100, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = bondData.object
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    frame.Parent = billboard
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = "üí∞ Treasury Bond"
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.Parent = frame
    
    bondESP[bondData.object] = billboard
end

local function updateBondESP()
    -- X√≥a ESP c≈©
    for obj, billboard in pairs(bondESP) do
        if not obj.Parent then
            billboard:Destroy()
            bondESP[obj] = nil
        end
    end
    
    -- T·∫°o ESP m·ªõi
    local bonds = findAllBonds()
    for _, bondData in ipairs(bonds) do
        if not bondESP[bondData.object] then
            createBondESP(bondData)
        end
    end
end

-- ESP Update Loop
task.spawn(function()
    while true do
        pcall(updateBondESP)
        task.wait(2) -- Update ESP m·ªói 2 gi√¢y
    end
end)

-- Kh·ªüi ƒë·ªông
lastBondCount = getCurrentBonds()
print("üöÄ Starting Bond Collector...")
print("üí∞ Current Bonds:", lastBondCount)

-- B·∫Øt ƒë·∫ßu auto collector
task.spawn(startAutoBondCollector)

-- Commands ƒë·ªÉ ƒëi·ªÅu khi·ªÉn
_G.AutoBondSettings = {
    toggleTeleport = function()
        TELEPORT_ENABLED = not TELEPORT_ENABLED
        print("üöÄ Teleport:", TELEPORT_ENABLED and "ON" or "OFF")
    end,
    
    toggleAutoCollect = function()
        AUTO_COLLECT_ENABLED = not AUTO_COLLECT_ENABLED
        print("üîÑ Auto Collect:", AUTO_COLLECT_ENABLED and "ON" or "OFF")
        if AUTO_COLLECT_ENABLED then
            task.spawn(startAutoBondCollector)
        end
    end,
    
    setDistance = function(distance)
        COLLECT_DISTANCE = distance
        print("üìè Collect Distance set to:", distance)
    end,
    
    getStats = function()
        print("üìä Bond Collector Stats:")
        print("üí∞ Current Bonds:", getCurrentBonds())
        print("üéØ Session Collected:", totalBondsCollected)
        print("üöÄ Teleport:", TELEPORT_ENABLED and "ON" or "OFF")
        print("üîÑ Auto Collect:", AUTO_COLLECT_ENABLED and "ON" or "OFF")
    end
}

print("‚úÖ Auto Bond Collector loaded!")
print("üìù Commands:")
print("_G.AutoBondSettings.toggleTeleport() - B·∫≠t/t·∫Øt teleport")
print("_G.AutoBondSettings.toggleAutoCollect() - B·∫≠t/t·∫Øt auto collect") 
print("_G.AutoBondSettings.setDistance(50) - ƒê·∫∑t kho·∫£ng c√°ch collect")
print("_G.AutoBondSettings.getStats() - Xem th·ªëng k√™")
