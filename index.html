local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local workspace = game:GetService("Workspace")

-- C·∫•u h√¨nh
local COLLECT_DISTANCE = 50  -- Kho·∫£ng c√°ch t√¨m ki·∫øm Bond
local TELEPORT_ENABLED = false  -- T·∫Øt teleport, d√πng tween
local AUTO_COLLECT_ENABLED = true  -- B·∫≠t/t·∫Øt auto collect
local COLLECT_DELAY = 0.5  -- TƒÉng delay ƒë·ªÉ ·ªïn ƒë·ªãnh h∆°n
local USE_TWEEN = true  -- D√πng tween thay v√¨ teleport

-- T√™n ch√≠nh x√°c c·ªßa Bond trong game - m·ªü r·ªông danh s√°ch
local BOND_NAMES = {
    "Treasury Bond",
    "TreasuryBond", 
    "Treasury_Bond",
    "Bond",
    "Coin",
    "Money",
    "Cash",
    "Dollar"
}

-- Tracking
local totalBondsCollected = 0
local lastBondCount = 0
local isMoving = false

-- Global stop flag
_G.Stop_Tween = false
_G.Clip = false

-- Function Tween t·ª´ b·∫°n
function Tween(P1)
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local humanoidRootPart = character.HumanoidRootPart
    local Distance = (P1.Position - humanoidRootPart.Position).Magnitude
    
    Speed = 500
    
    local virtualFloor = Instance.new("Part")
    virtualFloor.Size = Vector3.new(20, 1, 20) 
    virtualFloor.Anchored = true
    virtualFloor.CanCollide = true
    virtualFloor.Transparency = 1 -- Invisible
    virtualFloor.Name = "VirtualFloor"
    
    local function updateFloorPosition()
        if virtualFloor and virtualFloor.Parent then
            virtualFloor.CFrame = CFrame.new(humanoidRootPart.Position.X, humanoidRootPart.Position.Y - 3.5, humanoidRootPart.Position.Z)
        end
    end
    
    virtualFloor.Parent = workspace
    updateFloorPosition()
    
    local floorConnection = game:GetService("RunService").Heartbeat:Connect(updateFloorPosition)
    
    local tween = game:GetService("TweenService"):Create(
        humanoidRootPart,
        TweenInfo.new(Distance/Speed, Enum.EasingStyle.Linear),
        {CFrame = P1}
    )
    
    tween:Play()
    
    if _G.Stop_Tween then
        tween:Cancel()
        return false
    end
    
    _G.Clip = true
    wait(Distance/Speed)
    _G.Clip = false
    
    if floorConnection then
        floorConnection:Disconnect()
    end
    if virtualFloor and virtualFloor.Parent then
        virtualFloor:Destroy()
    end
    
    return true
end

-- H√†m ki·ªÉm tra Bond hi·ªán t·∫°i trong leaderstats
local function getCurrentBonds()
    local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
    if leaderstats then
        -- T√¨m stat Bond ch√≠nh x√°c - m·ªü r·ªông t√¨m ki·∫øm
        for _, statName in pairs({"Bond", "Bonds", "Treasury", "Money", "Cash", "Coin", "Dollar", "Currency"}) do
            local bondStat = leaderstats:FindFirstChild(statName)
            if bondStat and bondStat.Value then
                return bondStat.Value
            end
        end
    end
    
    return 0
end

-- H√†m debug ƒë·ªÉ xem c·∫•u tr√∫c leaderstats
local function debugLeaderstats()
    local leaderstats = LocalPlayer:FindFirstChild("leaderstats")
    if leaderstats then
        print("üìä Leaderstats found:")
        for _, child in pairs(leaderstats:GetChildren()) do
            print("  - " .. child.Name .. " = " .. tostring(child.Value))
        end
    else
        print("‚ùå No leaderstats found")
    end
end

-- H√†m t√¨m t·∫•t c·∫£ Bond trong workspace v·ªõi debug
local function findAllBonds()
    local bonds = {}
    
    local function searchInFolder(folder, depth)
        depth = depth or 0
        if depth > 10 then return end -- Tr√°nh infinite loop
        
        for _, obj in pairs(folder:GetChildren()) do
            -- T√¨m Bond v·ªõi nhi·ªÅu pattern kh√°c nhau
            local objName = obj.Name:lower()
            
            for _, bondName in pairs(BOND_NAMES) do
                if objName:find(bondName:lower()) or obj.Name == bondName then
                    local position = nil
                    
                    -- Ki·ªÉm tra nhi·ªÅu lo·∫°i object
                    if obj:IsA("Part") then
                        position = obj.Position
                        print("üîç Found Bond (Part):", obj.Name, "at", position)
                    elseif obj:IsA("Model") then
                        if obj.PrimaryPart then
                            position = obj.PrimaryPart.Position
                        else
                            local firstPart = obj:FindFirstChildOfClass("Part")
                            if firstPart then
                                position = firstPart.Position
                            end
                        end
                        if position then
                            print("üîç Found Bond (Model):", obj.Name, "at", position)
                        end
                    elseif obj:IsA("Tool") then
                        local handle = obj:FindFirstChild("Handle")
                        if handle then
                            position = handle.Position
                            print("üîç Found Bond (Tool):", obj.Name, "at", position)
                        end
                    end
                    
                    if position then
                        table.insert(bonds, {
                            object = obj,
                            position = position,
                            name = obj.Name,
                            type = obj.ClassName
                        })
                    end
                    break
                end
            end
            
            -- T√¨m trong c√°c folder con
            if obj:IsA("Folder") or obj:IsA("Model") then
                searchInFolder(obj, depth + 1)
            end
        end
    end
    
    searchInFolder(workspace)
    
    -- Debug: In ra t·∫•t c·∫£ Bond t√¨m ƒë∆∞·ª£c
    if #bonds > 0 then
        print("üéØ Total bonds found:", #bonds)
        for i, bond in ipairs(bonds) do
            print("  " .. i .. ". " .. bond.name .. " (" .. bond.type .. ")")
        end
    else
        print("‚ùå No bonds found in workspace")
    end
    
    return bonds
end

-- H√†m t√≠nh kho·∫£ng c√°ch
local function getDistance(pos1, pos2)
    return (pos1 - pos2).Magnitude
end

-- H√†m collect Bond v·ªõi nhi·ªÅu ph∆∞∆°ng ph√°p kh√°c nhau
local function collectBond(bondData)
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        return false
    end
    
    local hrp = character.HumanoidRootPart
    local distance = getDistance(hrp.Position, bondData.position)
    
    print("üéØ Attempting to collect:", bondData.name, "Distance:", math.floor(distance))
    
    -- Di chuy·ªÉn ƒë·∫øn Bond n·∫øu qu√° xa
    if distance > COLLECT_DISTANCE then
        if USE_TWEEN then
            print("üö∂ Moving to bond with tween...")
            isMoving = true
            local success = Tween(CFrame.new(bondData.position + Vector3.new(0, 3, 0)))
            isMoving = false
            if not success then
                return false
            end
            task.wait(0.2)
        elseif TELEPORT_ENABLED then
            hrp.CFrame = CFrame.new(bondData.position + Vector3.new(0, 3, 0))
            task.wait(0.1)
        else
            print("‚ùå Bond too far and movement disabled")
            return false
        end
    end
    
    -- Th·ª≠ nhi·ªÅu ph∆∞∆°ng ph√°p collect
    local success = false
    
    pcall(function()
        local targetObject = bondData.object
        
        -- Method 1: ClickDetector
        local function tryClickDetector(obj)
            local clickDetector = obj:FindFirstChildOfClass("ClickDetector")
            if clickDetector then
                fireclickdetector(clickDetector)
                print("‚úÖ Clicked with ClickDetector")
                success = true
                return true
            end
            return false
        end
        
        -- Method 2: ProximityPrompt
        local function tryProximityPrompt(obj)
            local proximityPrompt = obj:FindFirstChildOfClass("ProximityPrompt")
            if proximityPrompt then
                fireproximityprompt(proximityPrompt)
                print("‚úÖ Triggered ProximityPrompt")
                success = true
                return true
            end
            return false
        end
        
        -- Method 3: Touch/Contact
        local function tryTouch(obj)
            if obj:IsA("Part") then
                -- Simulate touch
                hrp.CFrame = CFrame.new(obj.Position)
                print("‚úÖ Touched part")
                success = true
                return true
            end
            return false
        end
        
        -- Th·ª≠ t·ª´ng method
        if not tryClickDetector(targetObject) then
            if not tryProximityPrompt(targetObject) then
                -- N·∫øu l√† Model, th·ª≠ tr√™n c√°c Part con
                if targetObject:IsA("Model") then
                    for _, child in pairs(targetObject:GetChildren()) do
                        if child:IsA("Part") then
                            if tryClickDetector(child) or tryProximityPrompt(child) then
                                break
                            end
                        end
                    end
                end
                
                -- Method cu·ªëi c√πng: Touch
                if not success then
                    tryTouch(targetObject)
                end
            end
        end
    end)
    
    return success
end

-- H√†m ki·ªÉm tra Bond c√≤n t·ªìn t·∫°i kh√¥ng
local function isBondStillThere(bondData)
    return bondData.object and bondData.object.Parent
end

-- Main Auto-Collect Loop
local function startAutoBondCollector()
    print("ü§ñ Auto Bond Collector Started!")
    print("üö∂ Using Tween Movement:", USE_TWEEN and "ON" or "OFF")
    print("üöÄ Teleport:", TELEPORT_ENABLED and "ON" or "OFF")
    print("üîÑ Auto Collect:", AUTO_COLLECT_ENABLED and "ON" or "OFF")
    print("üìè Collect Distance:", COLLECT_DISTANCE)
    
    -- Debug leaderstats l·∫ßn ƒë·∫ßu
    task.wait(1)
    debugLeaderstats()
    
    while AUTO_COLLECT_ENABLED do
        if not isMoving then
            pcall(function()
                -- Update Bond count
                local currentBonds = getCurrentBonds()
                if currentBonds ~= lastBondCount then
                    local gained = currentBonds - lastBondCount
                    if gained > 0 then
                        totalBondsCollected = totalBondsCollected + gained
                        print("üí∞ Bonds gained:", gained, "| Total:", currentBonds, "| Session:", totalBondsCollected)
                    end
                    lastBondCount = currentBonds
                end
                
                -- T√¨m v√† collect Bond
                local bonds = findAllBonds()
                if #bonds > 0 then
                    -- S·∫Øp x·∫øp theo kho·∫£ng c√°ch g·∫ßn nh·∫•t
                    local character = LocalPlayer.Character
                    if character and character:FindFirstChild("HumanoidRootPart") then
                        local myPos = character.HumanoidRootPart.Position
                        
                        table.sort(bonds, function(a, b)
                            return getDistance(myPos, a.position) < getDistance(myPos, b.position)
                        end)
                        
                        -- Collect Bond g·∫ßn nh·∫•t
                        for i, bondData in ipairs(bonds) do
                            if isBondStillThere(bondData) then
                                if collectBond(bondData) then
                                    print("‚úÖ Successfully collected:", bondData.name)
                                    task.wait(1) -- Ch·ªù l√¢u h∆°n sau khi collect
                                    break -- Ch·ªâ collect 1 bond m·ªói l·∫ßn
                                end
                            end
                        end
                    end
                else
                    print("‚è≥ No bonds found, waiting...")
                end
            end)
        end
        
        task.wait(COLLECT_DELAY)
    end
end

-- Commands ƒë·ªÉ ƒëi·ªÅu khi·ªÉn
_G.AutoBondSettings = {
    toggleTween = function()
        USE_TWEEN = not USE_TWEEN
        print("üö∂ Tween Movement:", USE_TWEEN and "ON" or "OFF")
    end,
    
    toggleTeleport = function()
        TELEPORT_ENABLED = not TELEPORT_ENABLED
        print("üöÄ Teleport:", TELEPORT_ENABLED and "ON" or "OFF")
    end,
    
    toggleAutoCollect = function()
        AUTO_COLLECT_ENABLED = not AUTO_COLLECT_ENABLED
        print("üîÑ Auto Collect:", AUTO_COLLECT_ENABLED and "ON" or "OFF")
        if AUTO_COLLECT_ENABLED then
            task.spawn(startAutoBondCollector)
        end
    end,
    
    setDistance = function(distance)
        COLLECT_DISTANCE = distance
        print("üìè Collect Distance set to:", distance)
    end,
    
    debugBonds = function()
        print("üîç Searching for bonds...")
        findAllBonds()
    end,
    
    debugStats = function()
        debugLeaderstats()
    end,
    
    getStats = function()
        print("üìä Bond Collector Stats:")
        print("üí∞ Current Bonds:", getCurrentBonds())
        print("üéØ Session Collected:", totalBondsCollected)
        print("üö∂ Tween Movement:", USE_TWEEN and "ON" or "OFF")
        print("üöÄ Teleport:", TELEPORT_ENABLED and "ON" or "OFF")
        print("üîÑ Auto Collect:", AUTO_COLLECT_ENABLED and "ON" or "OFF")
    end
}

-- Kh·ªüi ƒë·ªông
lastBondCount = getCurrentBonds()
print("üöÄ Starting Enhanced Bond Collector...")
print("üí∞ Current Bonds:", lastBondCount)

-- B·∫Øt ƒë·∫ßu auto collector
task.spawn(startAutoBondCollector)

print("‚úÖ Enhanced Auto Bond Collector loaded!")
print("üìù Commands:")
print("_G.AutoBondSettings.toggleTween() - B·∫≠t/t·∫Øt tween movement")
print("_G.AutoBondSettings.toggleTeleport() - B·∫≠t/t·∫Øt teleport")
print("_G.AutoBondSettings.toggleAutoCollect() - B·∫≠t/t·∫Øt auto collect") 
print("_G.AutoBondSettings.setDistance(50) - ƒê·∫∑t kho·∫£ng c√°ch collect")
print("_G.AutoBondSettings.debugBonds() - Debug t√¨m bonds")
print("_G.AutoBondSettings.debugStats() - Debug leaderstats")
print("_G.AutoBondSettings.getStats() - Xem th·ªëng k√™")
